# alertmanager.yml
# ConfiguraciÃ³n de Alertmanager para Litper
# ==========================================

global:
  resolve_timeout: 5m
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alertas@litper.co'
  smtp_auth_username: '${SMTP_USERNAME}'
  smtp_auth_password: '${SMTP_PASSWORD}'

  # Slack (opcional)
  slack_api_url: '${SLACK_WEBHOOK_URL}'

# Inhibiciones - Evitar alertas duplicadas
inhibit_rules:
  # Si la API estÃ¡ caÃ­da, no alertar sobre servicios individuales
  - source_match:
      alertname: 'LitperAPIDown'
    target_match_re:
      alertname: '.+'
    equal: ['instance']

  # Si la BD estÃ¡ caÃ­da, no alertar sobre otros problemas de datos
  - source_match:
      alertname: 'DatabaseDown'
    target_match_re:
      alertname: 'HighLatency|SlowChatResponse'
    equal: []

route:
  group_by: ['alertname', 'severity']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  receiver: 'default'

  routes:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # CRÃTICAS -> WhatsApp + Llamada + Email
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - match:
        severity: critical
      receiver: 'critical-alerts'
      repeat_interval: 5m
      continue: true

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ALTAS -> WhatsApp + Email
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - match:
        severity: high
      receiver: 'high-alerts'
      repeat_interval: 30m
      continue: true

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # MEDIAS -> Solo Email
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - match:
        severity: medium
      receiver: 'medium-alerts'
      repeat_interval: 4h

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # NEGOCIO -> Email a gerencia
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - match:
        team: business
      receiver: 'business-alerts'
      repeat_interval: 4h

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # AI/ML -> Email a equipo de IA
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - match:
        team: ai
      receiver: 'ai-team-alerts'
      repeat_interval: 2h

receivers:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DEFAULT - Solo email
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - name: 'default'
    email_configs:
      - to: 'tech@litper.co'
        send_resolved: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CRÃTICAS - Todo canal disponible
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - name: 'critical-alerts'
    email_configs:
      - to: 'tech@litper.co,ceo@litper.co,cto@litper.co'
        send_resolved: true
        html: '{{ template "email.html" . }}'

    webhook_configs:
      # WhatsApp vÃ­a API interna
      - url: 'http://notification-service:8006/internal/alerts/whatsapp'
        send_resolved: true
        http_config:
          bearer_token: '${INTERNAL_API_TOKEN}'

      # PagerDuty para llamadas (opcional)
      # - url: 'https://events.pagerduty.com/v2/enqueue'
      #   send_resolved: true

    slack_configs:
      - channel: '#alerts-critical'
        send_resolved: true
        title: '{{ if eq .Status "firing" }}ğŸ”´{{ else }}âœ…{{ end }} {{ .CommonAnnotations.summary }}'
        text: '{{ .CommonAnnotations.description }}'
        actions:
          - type: button
            text: 'Runbook'
            url: '{{ .CommonAnnotations.runbook }}'
          - type: button
            text: 'Silence'
            url: '{{ template "__alertmanagerURL" . }}/#/silences/new?filter=%7Balertname%3D%22{{ .CommonLabels.alertname }}%22%7D'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ALTAS - WhatsApp + Email
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - name: 'high-alerts'
    email_configs:
      - to: 'tech@litper.co'
        send_resolved: true

    webhook_configs:
      - url: 'http://notification-service:8006/internal/alerts/whatsapp'
        send_resolved: true
        http_config:
          bearer_token: '${INTERNAL_API_TOKEN}'

    slack_configs:
      - channel: '#alerts-high'
        send_resolved: true
        title: '{{ if eq .Status "firing" }}ğŸŸ {{ else }}âœ…{{ end }} {{ .CommonAnnotations.summary }}'
        text: '{{ .CommonAnnotations.description }}'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # MEDIAS - Solo email
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - name: 'medium-alerts'
    email_configs:
      - to: 'tech@litper.co'
        send_resolved: true

    slack_configs:
      - channel: '#alerts-medium'
        send_resolved: true
        title: '{{ if eq .Status "firing" }}ğŸŸ¡{{ else }}âœ…{{ end }} {{ .CommonAnnotations.summary }}'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # NEGOCIO - Email a gerencia
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - name: 'business-alerts'
    email_configs:
      - to: 'gerencia@litper.co,tech@litper.co'
        send_resolved: true
        html: '{{ template "business_email.html" . }}'

    slack_configs:
      - channel: '#business-metrics'
        send_resolved: true
        title: 'ğŸ“Š {{ .CommonAnnotations.summary }}'
        text: '{{ .CommonAnnotations.description }}'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # AI TEAM - Alertas especÃ­ficas de IA
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - name: 'ai-team-alerts'
    email_configs:
      - to: 'ai-team@litper.co'
        send_resolved: true

    slack_configs:
      - channel: '#ai-alerts'
        send_resolved: true
        title: 'ğŸ¤– {{ .CommonAnnotations.summary }}'
        text: '{{ .CommonAnnotations.description }}'

templates:
  - '/etc/alertmanager/templates/*.tmpl'
